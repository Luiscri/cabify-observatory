<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<script src="https://d3js.org/d3.v3.min.js"></script>

<dom-module id="spider-chart">

<style is="custom-style">
  @import url("../../styles/app-theme.html");
</style>
<link rel="import" type="css" href="spider-chart.css">
 <template>

 	<style>
		#marco {
		  overflow: hidden;
		  margin: 0;
		  font-size: 14px;
		  font-family: "Helvetica Neue", Helvetica;
		}

		#spiderchart {
		  /*position: absolute;*/
		  top: 0px;
		  left: 0px;
		}
		#help10{
			background: rgba(255, 255, 255, 0.6);
			color: #000;
		}
		#help9{
			background: rgba(255, 255, 255, 0.6);
			color: #000;
		}
		#help8{
			background: rgba(255, 255, 255, 0.6);
			color: #000;
		}
		#help10 p{
			color: #000;
		}
		#help9 p{
			color: #000;
		}
		#help8 p{
			color: #000;
		}	
	</style>

  	<paper-material elevation="1">
  	<div class="top-bar">
        <iron-icon icon="{{icon}}"></iron-icon>
        <span>{{title}}</span>
    </div>
  	<div id="marco">
 	 <div id="spiderchart" ></div>
 	</div>
 	<div style="float: right; bottom: 10px; width: 100%; display: flex; flex-direction: row; justify-content: flex-end; align-content: center;">
        <small style="align-self: center;">Clear Filters</small>
        <paper-icon-button icon="delete" alt="menu" class="green" on-tap="removeFilters"></paper-icon-button>
      </div>
      <div style="width:100%; clear: both"></div>
 	</paper-material>

 </template>

 <script>
 	var filtered = false;
    Polymer({

      is: 'spider-chart',

      properties: {

	      icon: {
	          type: String,
	          value: "trending-up"
	        },

	      index: {
	          type: String
	        },
	      entity: {
	      	type: String
	       },

	       datos:{
	       	type: Object,
	       	observer: '_dataChanged'
	       },

	      subindex: {
	          type: String
	        },

	      extraId: {
	          type: String
	        },

	        idhelp: {
	        	type: String
	        },

	      fields: {
	          type: Array,
	          value: function() { return []; }
	        },

	      field: {
	      	type: String,
	      	value: "taxonomies"
	      },

	      query: {
	          type: String,
	          observer: '_queryChanged'
	        },

	      title: {
	          type: String,
	          value: "Spider Chart"
	      },

	      filters: {
          type: Array,
          notify: true,
          value: function() { return []; }
        }
	  },

      ready: function(){

	  },
	  
	  _dataChanged: function() {

		  	
		var that = this;
		var aggs = []

		aggs.push(this.datos.aggregations[this.entity]["buckets"])
		
		that._initiategraph(aggs);
		filtered = true
			
	  },

	  removeFilters: function(){
        this.filters = [];
      },
	  
	  _draw: function(id, d, options){
	  	//console.log("entro funcion _draw");
	  	var that = this
		  var cfg = {
			 radius: 6,
			 w: 400,
			 h: 500,
			 factor: 1,
			 factorLegend: 0.9,
			 levels: 3,
			 maxValue: 0,
			 radians: 2 * Math.PI,
			 opacityArea: 0.4,
			 ToRight: 5,
			 TranslateX: 45,
			 TranslateY: 50,
			 ExtraWidthX: 500,
			 ExtraWidthY: 100,
			 color: d3.scale.category10()
			};
			
			if('undefined' !== typeof options){
			  for(var i in options){
				if('undefined' !== typeof options[i]){
				  cfg[i] = options[i];
				}
			  }
			}

			cfg.maxValue = Math.max(cfg.maxValue, d3.max(d, function(i){return d3.max(i.map(function(o){return o.value;}))}));
			var allAxis = (d[0].map(function(i, j){return i.axis}));
			var total = allAxis.length;
			var radius = cfg.factor*Math.min(cfg.w/2, cfg.h/2);
			var Format = d3.format(' ');
			d3.select(id).select("svg").remove();
			
			var g = d3.select(id)
					.append("svg")
					.attr("width", cfg.w+cfg.ExtraWidthX)
					.attr("height", 385)
					.append("g")
					.attr("transform", "translate(" + cfg.TranslateX + "," + cfg.TranslateY + ")");
					;

			var tooltip;
			
			//Circular segments
			for(var j=0; j<cfg.levels-1; j++){
			  var levelFactor = cfg.factor*radius*((j+1)/cfg.levels);
			  g.selectAll(".levels")
			   .data(allAxis)
			   .enter()
			   .append("svg:line")
			   .attr("x1", function(d, i){return levelFactor*(1-cfg.factor*Math.sin(i*cfg.radians/total));})
			   .attr("y1", function(d, i){return levelFactor*(1-cfg.factor*Math.cos(i*cfg.radians/total));})
			   .attr("x2", function(d, i){return levelFactor*(1-cfg.factor*Math.sin((i+1)*cfg.radians/total));})
			   .attr("y2", function(d, i){return levelFactor*(1-cfg.factor*Math.cos((i+1)*cfg.radians/total));})
			   .attr("class", "line")
			   .style("stroke", "grey")
			   .style("stroke-opacity", "0.75")
			   .style("stroke-width", "0.3px")
			   .attr("transform", "translate(" + (cfg.w/2-levelFactor) + ", " + (cfg.h/2-levelFactor) + ")");
			}

			//Text indicating at what % each level is
			/*for(var j=0; j<cfg.levels; j++){
			  var levelFactor = cfg.factor*radius*((j+1)/cfg.levels);
			  g.selectAll(".levels")
			   .data([1]) //dummy data
			   .enter()
			   .append("svg:text")
			   .attr("x", function(d){return levelFactor*(1-cfg.factor*Math.sin(0));})
			   .attr("y", function(d){return levelFactor*(1-cfg.factor*Math.cos(0));})
			   .attr("class", "legend1")
			   .style("font-family", "sans-serif")
			   .style("font-size", "10px")
			   .attr("transform", "translate(" + (cfg.w/2-levelFactor + cfg.ToRight) + ", " + (cfg.h/2-levelFactor) + ")")
			   .attr("fill", "#737373")
			   .text(Format((j+1)*cfg.maxValue/cfg.levels));
			}*/
			
			series = 0;

			var axis = g.selectAll(".axis1")
					.data(allAxis)
					.enter()
					.append("g")
					.attr("class", "axis1");

			axis.append("line")
				.attr("x1", cfg.w/2)
				.attr("y1", cfg.h/2)
				.attr("x2", function(d, i){return cfg.w/2*(1-cfg.factor*Math.sin(i*cfg.radians/total));})
				.attr("y2", function(d, i){return cfg.h/2*(1-cfg.factor*Math.cos(i*cfg.radians/total));})
				.attr("class", "line")
				.style("stroke", "grey")
				.style("stroke-width", "1px");

			axis.append("text")
				.attr("class", "legend1")
				.text(function(d){return d.substr(d.lastIndexOf("/")+1)})
				.style("font-family", "sans-serif")
				.style("font-size", "11px")
				.attr("text-anchor", "middle")
				.attr("dy", "1.5em")
				.attr("transform", function(d, i){return "translate(0, -20)"})
				.attr("x", function(d, i){return cfg.w/2*(1-cfg.factorLegend*Math.sin(i*cfg.radians/total))-60*Math.sin(i*cfg.radians/total);})
				.attr("y", function(d, i){return cfg.h/2*(1-Math.cos(i*cfg.radians/total))-20*Math.cos(i*cfg.radians/total);});

		 
			d.forEach(function(y, x){
			  dataValues = [];
			  g.selectAll(".nodes")
				.data(y, function(j, i){
				  dataValues.push([
					cfg.w/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total)), 
					cfg.h/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total))
				  ]);
				});
			  dataValues.push(dataValues[0]);
			  g.selectAll(".area")
							 .data([dataValues])
							 .enter()
							 .append("polygon")
							 .attr("class", "radar-chart-serie"+series)
							 .style("stroke-width", "2px")
							 .style("stroke", cfg.color(series))
							 .attr("points",function(d) {
								 var str="";
								 for(var pti=0;pti<d.length;pti++){
									 str=str+d[pti][0]+","+d[pti][1]+" ";
								 }
								 return str;
							  })
							 .style("fill", function(j, i){return cfg.color(series)})
							 .style("fill-opacity", cfg.opacityArea)
							 .on('mouseover', function (d){
												z = "polygon."+d3.select(this).attr("class");
												g.selectAll("polygon")
												 .transition(200)
												 .style("fill-opacity", 0.1); 
												g.selectAll(z)
												 .transition(200)
												 .style("fill-opacity", .7);
											  })
							 .on('mouseout', function(){
												g.selectAll("polygon")
												 .transition(200)
												 .style("fill-opacity", cfg.opacityArea);
							 });
			  series++;
			});
			series=0;


			d.forEach(function(y, x){
			  g.selectAll(".nodes")
				.data(y).enter()
				.append("svg:circle")
				.attr("class", "radar-chart-serie"+series)
				.attr('r', cfg.radius)
				.attr("alt", function(j){return Math.max(j.value, 0)})
				.attr("cx", function(j, i){
				  dataValues.push([
					cfg.w/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total)), 
					cfg.h/2*(1-(parseFloat(Math.max(j.value, 0))/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total))
				]);
				return cfg.w/2*(1-(Math.max(j.value, 0)/cfg.maxValue)*cfg.factor*Math.sin(i*cfg.radians/total));
				})
				.attr("cy", function(j, i){
				  return cfg.h/2*(1-(Math.max(j.value, 0)/cfg.maxValue)*cfg.factor*Math.cos(i*cfg.radians/total));
				})
				.attr("data-id", function(j){return j.axis})
				.style("fill", cfg.color(series)).style("fill-opacity", .9)
				.on('mouseover', function (d){
							newX =  parseFloat(d3.select(this).attr('cx')) - 10;
							newY =  parseFloat(d3.select(this).attr('cy')) - 5;
							
							tooltip
								.attr('x', newX)
								.attr('y', newY)
								.text(Format(d.value))
								.transition(200)
								.style('opacity', 1);
								
							z = "polygon."+d3.select(this).attr("class");
							g.selectAll("polygon")
								.transition(200)
								.style("fill-opacity", 0.1); 
							g.selectAll(z)
								.transition(200)
								.style("fill-opacity", .7);
						  })
				.on('mouseout', function(){
							tooltip
								.transition(200)
								.style('opacity', 0);
							g.selectAll("polygon")
								.transition(200)
								.style("fill-opacity", cfg.opacityArea);
						  })
				.on('click', function(d){
					var myfilters = [d.axis]
        			var field ="taxonomies.rdfs:label.keyword"
        			
        			var terms = {}
        			terms[field]=myfilters
        			that.push('filters', { terms: terms})
					})
				.append("svg:title")
				.text(function(j){return Math.max(j.value, 0)});

			  series++;
			});
			//Tooltip
			tooltip = g.append('text')
					   .style('opacity', 0)
					   .style('font-family', 'sans-serif')
					   .style('font-size', '13px');


		  },

	    _initiategraph: function(data){
	    var w, h, transX, transY = 0;
		//console.log(data);
		/*for(var i=0;i<data.length;i++){
		console.log(Object.keys(data[i]));
		}*/
		colorscale = d3.scale.category10();
		
		var LegendOptions = [];
		//Legend titles
		/*for (var i = 0; i< data.children.length; i++){
		//LegendOptions.push(data.children[i].name);
	    }*/

	    //LegendOptions.push(this.entity)


		//console.log(data.children[0].children[0].name);
		//console.log(data.children[0].children[0].children.length)
		//console.log(data[0].entries[0].sentiments[0]["marl:describesObjectFeature"])
		/*var food = 0
		var restaurant = 0
		var service = 0
		var drinks = 0
		var location = 0
		var ambience = 0

		for (var i=0; i< data.length; i++){
			for(var j=0; j<data[i].entries[0].sentiments.length; j++){
				if(data[i].entries[0].sentiments[j]["marl:describesObjectFeature"].indexOf("restaurant")>-1){
					restaurant++
				}
				if(data[i].entries[0].sentiments[j]["marl:describesObjectFeature"].indexOf("location")>-1){
					location++
				}if(data[i].entries[0].sentiments[j]["marl:describesObjectFeature"].indexOf("drinks")>-1){
					drinks++
				}if(data[i].entries[0].sentiments[j]["marl:describesObjectFeature"].indexOf("food")>-1){
					food++
				}if(data[i].entries[0].sentiments[j]["marl:describesObjectFeature"].indexOf("ambience")>-1){
					ambience++
				}if(data[i].entries[0].sentiments[j]["marl:describesObjectFeature"].indexOf("service")>-1){
					service++
				}
			}
		}*/


		/*var a = []
		data.forEach(function(entry){
			a.push({axis:entry.key, value:entry.doc_count});				
		});

		var d = []
		d.push(a)*/

		
		/*datos = [{"key": "Patinete", "value": 0.15*100},
				{"key": "Coche eléctrico", "value": 0.15*100},
				{"key": "Bicicleta", "value": 0.2*100},
				{"key": "Peatón", "value": 0.3*100},
				{"key": "Avión eléctrico", "value": 0.15*100},
				{"key": "Motocicleta eléctrica", "value": 0.2*100},
				{"key": "Transporte bajo demanda", "value": 0.5*100},
				{"key": "Coche autónomo", "value": 0.8*100}]*/
				
		var a = []
		var total = 0
				data[0].forEach(function(entry){

					//tag = entry.key;
					//name = tag.substr(tag.lastIndexOf("/")+1);

					a.push({axis:entry.key, value:entry.doc_count})

					if(total < entry.doc_count){
						total = entry.doc_count;
					}
				});

				w = 300;
				h = 300;
				transX = 120;
				transY = 50;

		var d = []
		d.push(a.slice(0,10))

		/*var d = [
					[
				

					{axis: "Food", value: food},
					{axis: "Restaurant", value: restaurant},
					{axis: "Location", value: location},
					{axis: "Drinks", value: drinks},
					{axis: "Service", value: service},
					{axis: "Ambience", value: ambience}
					]
					
					
		];*/
		//console.log(d);
		/*var LegendOptions = ['Smartphone','Tablet'];*/

		//Data
		/*var d = [
				  [
					{axis:"Email",value:0.59},
					{axis:"Social Networks",value:0.56},
					{axis:"Internet Banking",value:0.42},
					{axis:"News Sportsites",value:0.34},
					{axis:"Search Engine",value:0.48},
					{axis:"View Shopping sites",value:0.14},
					{axis:"Paying Online",value:0.11},
					{axis:"Buy Online",value:0.05}
					
				  ],[
					{axis:"Email",value:0.48},
					{axis:"Social Networks",value:0.41},
					{axis:"Internet Banking",value:0.27},
					{axis:"News Sportsites",value:0.28},
					{axis:"Search Engine",value:0.46},
					{axis:"View Shopping sites",value:0.29},
					{axis:"Paying Online",value:0.80},
					{axis:"Buy Online",value:0.14}
				  ]
				];*/
		
		//Options for the Radar chart, other than default
		var mycfg = {
		  w: w,
		  h: h,
		  maxValue: total + 1,
		  levels: 10,  
		  ToRight: 5,
		  TranslateX: transX,
		  TranslateY: transY
		}

		//Call function to draw the Radar chart
		//Will expect that data is in %'s
		var that = this;
		this._draw(this.$.spiderchart, d, mycfg);



		////////////////////////////////////////////
		/////////// Initiate legend ////////////////
		////////////////////////////////////////////

		var svg = d3.select(this.$.marco)
			.selectAll('svg')
			.append('svg')
			.attr("width", w+300)
			.attr("height", 385);

		//console.log(svg);

		//Create the title for the legend
		
				
		//Initiate Legend	
		var legend = svg.append("g")
			.attr("class", "legend1")
			.attr("height", 100)
			.attr("width", 200)
			.attr('transform', 'translate(140,50)') 
			.attr("y", 10);
			//Create colour squares
			legend.selectAll('rect')
			  .data(LegendOptions)
			  .enter()
			  .append("rect")
			  .attr("x", w - 65)
			  .attr("y", function(d, i){ return i * 20;})
			  .attr("width", 10)
			  .attr("height", 10)
			  .style("fill", function(d, i){ return colorscale(i);})
			  ;
			//Create text next to squares
			legend.selectAll('text')
			  .data(LegendOptions)
			  .enter()
			  .append("text")
			  .attr("x", w - 52)
			  .attr("y", function(d, i){ return i * 20 + 9;})
			  .attr("font-size", "11px")
			  .attr("fill", "#737373")
			  .text(function(d) { return d; });	
	      }


	});
</script>
</dom-module>
