<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>

<dom-module id="news-loader">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="import" type="css" href="./news-loader.css">

    <template>
        <template is="dom-repeat" items="{{articles}}" as="article">
            <div class="row d-flex flex-column align-items-center">
                <div class="col-12 col-md-8">
                    <div class="imageContainer">
                        <img
                            class="newsImage"
                            src={{article.schema:thumbnailUrl}}
                            onerror$="this.src={{defaultimage}}"
                            on-tap="handleClick"
                            data-id$="[[article.id]]"
                        >
                    </div>
                    <div class="metadata">
                        <img class="imageIcon" src={{getFavIcon(article)}}>
                        <a class="source" target="_blank" href$="https://{{getSources(article)}}">{{getSources(article)}}</a>
                        <img class="imageIcon" src="./assets/img/calendar.png">
                        <p class="underImage">{{getDate(article)}}</p>
                        <div class="tags"><iron-icon icon="label" class="mr-1"></iron-icon>Etiquetas:</div>
                    </div>
                    <h3
                        class="title"
                        on-tap="handleClick"
                        data-id$="[[article.id]]"
                    >
                        {{article.schema:headline}}
                    </h3>
                    <hr>
                    <div class="newsResume">
                        <p>
                            {{getText(article)}}
                        </p>
                    </div>
                    <div class="see-more-button mr-4" on-tap="handleClick" data-id$="[[article.id]]">
                        <span on-tap="handleClick" data-id$="[[article.id]]">Leer m√°s</span>
                    </div>
                    <hr class="hrFinal">
                </div>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            is: 'news-loader',
            properties: {
                data: {
                  type: Object,
                  observer: '_dataChanged'
                },

                articles:{
                  type: Array,
                  value: [],
                },

                defaultimage: {
                  type: String
                }
            },

            ready: function() {   

            },

            _dataChanged: function() {
                var that = this;
                var hits = this.data.hits.hits;
                var results = []
                 
                hits.forEach(function(article) {
                    results.push(article._source);
                });

                that.articles = results.slice(1); // Ignore first article
                //console.log(this.articles)
            },

            handleClick: function(e, detail) {
                let id = e.target.dataset.id;
                let clicked;
                for(let article of this.articles){
                    if(article['id'] == id){
                        clicked = article;
                        break;
                    }
                }
                this.fire('articleSelected', {article: clicked});
            },

            getSources: function(article) {
                source = article.id;
                var match = source.match(/:\/\/([0-9]?\.)?(.[^/:]+)/i);
                if (match != null && match.length > 2 && typeof match[2] === 'string' && match[2].length > 0) {
                  return match[2];
                }
                else {
                  return null;
                }
            },

            getFavIcon: function(article) {
                source = this.getSources(article);
                return "http://www.google.com/s2/favicons?domain=" + source;
            },

            getArticles: function(articles) {
                return articles
            },

            getDate: function(article) {
                date = article['schema:datePublished'];
                return date.substring(0,10);
            },

            getText: function(article) {
                text = article['schema:articleBody'];
                return text.substring(0,500) + '[...]';
            }
        });
    </script>
</dom-module>