<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/elements/happymap/happymap-element.html">
<link rel="import" href="/elements/material-search/material-search.html">
<link rel="import" href="/elements/tweet-chart/tweet-chart.html">
<link rel="import" href="/elements/number-chart/number-chart.html">
<link rel="import" href="/elements/podium-chart/podium-chart.html">
<link rel="import" href="/elements/articles-loader/articles-loader.html">
<link rel="import" href="/elements/google-chart-elasticsearch/google-chart.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<dom-module id="cabify-dashboard">
    <link rel="import" type="css" href="styles/cabify-dashboard.css">

    <template>
        <div class="centerBoth mt-5 w-100">
            <div class="top">
                <img src="img/logoObservatorio.png" style="width: 70%; height: auto;">
            </div>
        </div>

        <div class="container my-5">

            <paper-tabs selected="{{selected}}">
                <paper-tab>Noticias</paper-tab>
                <paper-tab>Estadísticas</paper-tab>
            </paper-tabs>

            <material-search
                active=True
                search-value="{{query}}"
                filters="{{filters}}">        
            </material-search>

            <iron-pages selected={{selected}}>
                <div class="mt-5">
                    <articles-loader
                        data="{{articlesData}}"
                        filters="{{filters}}"
                    >
                    </articles-loader>
                </div>

                <div>
                
                </div>
            </iron-pages>
        </div>   

        <div class="footer">
            <img class="gsi_logo" src="img/gsi_blanco.svg">
        </div>
    </template>

    <script>
        var ready = false;
        Polymer({
            is: 'cabify-dashboard',
            properties: {
                selected: {
                  type: Number,
                  value: 0
                }, 

                articlesData: {
                  type: Object
                },

                query: {
                    type: String,
                },

                client: {
                  type: Object,
                  notify: true,
                  observer: '_clientChanged'              
                },

                fields: {
                  type: Array,
                  value: function() { return []; }
                },

                filters: {
                  type: Array,
                  notify: true,
                  value: function() { return []; }
                }
            },
        
            observers: [
              '_filtersChange(filters.*)'
            ],

            behaviors: [
                Polymer.IronA11yKeysBehavior
            ],

            keyBindings: {
                'enter': '_search'
            },

            ready: function(){
                /*
                let that = this;
                let ironPages = Polymer.dom(that.root).querySelector('iron-pages');

                // Añadimos el listener a los articulos
                Polymer.dom(that.root).querySelectorAll('main-article-frame, news-loader').forEach(function(clickable){
                    clickable.addEventListener('articleSelected', function(e){
                        Polymer.dom(that.root).querySelector('article-viewer').data = e.detail.article;
                        Polymer.dom(that.root).querySelector('article-viewer').display = true;
                        document.body.style.overflow = "hidden";
                    });
                });
                */

                console.log("Ready");
            },

            _clientChanged: function() {
                console.log("ClientChanged");
                ready = true;
                this._query();
            },

            _filtersChange: function() {
                this._query();
            },

            _search: function(){
                //console.log("search fired")
                //console.log(this.query.length)
                if (this.query.length == 0){
                  //console.log("default search fired")
                  this.filters = [];
                  this._query()
                }
                else {
                  this.push('filters', {terms: {'text': [this.query]}});
                  this._query()
                }
            },

            _query: function() {
                console.log("_filtersChangedash")
                var that = this;
                console.log("Ready?: ", ready);
                if(ready){
                    this.client.search({
                        // undocumented params are appended to the query string
                        index: "articles",
                        type: "article",
                        body: {
                            size: 1000,
                            query: {
                                bool: {
                                    must: this.filters,
                                }
                            },
                            aggs: {
                                'entities.name': {
                                    terms: {
                                        field: "entities.schema:name.keyword",
                                        size : 50,
                                        order: {
                                            _count: "desc"
                                        }
                                    },
                                    aggs: {
                                        'entity_type': {
                                            "top_hits": {
                                                "_source": {
                                                    "includes": ["entities.@type","entities.schema:name"]
                                                },
                                                "size" : 1
                                            }
                                        }
                                    }
                                },
                            }      
                        }
                    }).then(function(resp) {
                        that.articlesData = resp;
                        console.log("Articles uploaded");

                    });
                }
            }
        });
    </script>
</dom-module>